import hsfs
import pandas as pd
from features import ip_features as ipf


def connect(featurestore : str) -> hsfs.feature_store.FeatureStore:
    connection = hsfs.connection(
        host="791bb4a0-bb1c-11ec-8721-7bd8cdac0b54.cloud.hopsworks.ai", # hostname for your Hopsworks cluster
        project=featurestore,
        engine="hive",
        secrets_store="local",
        api_key_file="./api-key.txt"
    )
    return connection.get_feature_store()


def engineer_features(df: pd.DataFrame) -> pd.DataFrame:
    df['ip_str'] = df.ip.apply(ipf.ip_int_to_str)
    df['city'] = df.ip_str.apply(ipf.ip_str_to_city)
    return df


def read_data(path: str) -> pd.DataFrame: 
    return pd.read_csv(path, dtype={'is_attributed': 'bool'}, parse_dates=['click_time'])


def run(project: str) : 
    # First, you have to create a project on Hopsworks called 'prod'
    fs = connect(project)
    try:
        fg = fs.get_feature_group("clicks",version=1)
    except:
        print("Creating feature group...")
        fg = fs.create_feature_group("clicks",
                        version=1,
                        description="User clicks on our website",
                        primary_key=['id'],
                        online_enabled=True)

    df = read_data("sample-click-logs.csv")
    df = engineer_features(df)

    fg.save(df)


run("prod")
